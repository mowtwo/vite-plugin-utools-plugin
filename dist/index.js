var N="vite-plugin-utools-plugin";import e from"node:path";import n from"node:fs/promises";import M from"ora";import T from"node:path";import U from"node:fs/promises";function S(o,a){return o=o.endsWith("plugin.json")?o:T.join(o,"plugin.json"),U.writeFile(o,a,{encoding:"utf-8"})}function W(o,a,r,c,v){let P={logo:a,main:r,features:[]};return JSON.stringify(o?{...P,development:{main:`${c}/${r}`},$schema:v}:P,void 0,2)}function C(o){let a={...o};return delete a.$schema,delete a.development,a}import{globby as V}from"globby";import{build as H}from"tsup";function A(o,a,r,c,...v){return H({dts:!1,watch:!1,entry:v,outDir:a,sourcemap:o,clean:!1,format:"cjs",noExternal:r,bundle:!0,minify:!1,target:`node${c??14}`,platform:"node",outExtension(){return{js:".js"}}})}import _ from"chokidar";var x=M({prefixText:"[utools]"});function q(o,a,r){let c=t=>e.resolve(process.cwd(),t),v=t=>t.endsWith("/")?t.slice(0,t.length-1):t,P=t=>n.stat(t).then(s=>s.isDirectory()).catch(()=>!1),J=t=>n.stat(t).then(s=>s.isFile()).catch(()=>!1),R=(t,s)=>{let i=r?.tsup?.ignoreEntry;if(!i)return!1;let m=d=>typeof d=="string"?d===t:d.test(t);return Array.isArray(i)?i.some(d=>m(d)):typeof i=="function"?i(t,s):m(i)},$=async t=>{let s=c("package.json");await J(s)&&JSON.parse(await n.readFile(s,{encoding:"utf-8"})).type==="module"&&(x.warn("\u6839\u9879\u76EE\u8DEF\u5F84\u4E3Aesm\u6A21\u5F0F\uFF0C\u521B\u5EFApackage.json\u4FDD\u8BC1\u517C\u5BB9"),await n.writeFile(e.join(t,"package.json"),JSON.stringify({type:"commonjs"},void 0,2),{encoding:"utf-8"}))},p=!0,I="",L="",f="",u="",g="",E,j="",D=(t,s,...i)=>A(t,s,r?.tsup?.noExternal??[],r?.tsup?.nodeVersion??14,...i),O=()=>V(["*.ts","*.tsx","*.js","*.jsx"],{onlyFiles:!0,cwd:g}).then(t=>t.filter(s=>!R(e.join(g,s),p)).map(s=>`${e.relative(process.cwd(),g)}/${s}`));return{name:N,config(t,s){p=s.command!=="build",(r?.build?.relativeBasePath??!0)&&!p&&(x.warn("\u6253\u5305\u5F3A\u5236\u4F7F\u7528\u76F8\u5BF9\u8DEF\u5F84"),t.base===void 0?t.base="./":t.base.startsWith("/")&&(t.base="."+t.base));let m=r?.server??{host:"localhost"};return t.server??={},Object.assign(t.server,m),f=c(e.relative(process.cwd(),o)),t},async configResolved(t){let s=!!t.server.https,i=parseInt(String(t.server.port??5173)),m=t.server.host??"localhost";I=c(e.relative(process.cwd(),t.publicDir)),L=c(e.relative(process.cwd(),t.build.outDir));let d=`${s?"https":"http"}//${m}:${i}`;g=c(a);let y=r?.clean??!0,h=v(r?.devDir??".utools");(h==="public"||h==="./public"||h==="/public")&&(h+="/.utools"),u=c(h),y&&await n.rm(u,{force:!0,recursive:!0}),await P(g)||(x.warn(`${a}\u4E0D\u5B58\u5728\uFF0C\u521B\u5EFA\u8BE5\u6587\u4EF6\u5939`),await n.mkdir(g,{recursive:!0}));let b=e.join(g,"plugin.json"),F=e.basename(f);if(await J(b)||await S(b,W(p,F,r?.utools?.main??"index.html",d,r?.utools?.jsonSchemaPath??"../node_modules/utools-api-types/resource/utools.schema.json")),j=e.join(g,F),f!==j&&await n.copyFile(f,j),p){await n.mkdir(u,{recursive:!0}),await n.copyFile(b,e.join(u,"plugin.json")),await n.copyFile(j,e.join(u,F)),await $(u);let k=await O();console.log(k),k.length>0&&await D(p,u,...k);let B=l=>{[".js",".ts",".tsx",".jsx"].some(w=>l.endsWith(w))&&D(p,u,e.relative(process.cwd(),l).replaceAll("\\","/")),(l===f||l===b)&&n.copyFile(l,e.join(u,e.basename(l)))};E=_.watch(g).on("change",B).on("add",B).on("unlink",l=>{if([".js",".ts",".tsx",".jsx"].some(w=>l.endsWith(w))){let w=e.join(u,e.relative(g,l)).replace(".ts",".js").replace(".jsx",".js").replace(".tsx",".js");n.rm(w,{force:!0,recursive:!0}),n.rm(w+".map",{force:!0,recursive:!0})}(l===f||l===b)&&n.rm(e.join(u,e.basename(l)),{force:!0,recursive:!0})})}},async closeBundle(){E?.close();let t=c("dist");if(!p&&await P(t)){let s=e.join(t,"plugin.json"),i=e.basename(f),m=e.join(g,"plugin.json");if(await J(j)){let h=JSON.parse(await n.readFile(m,{encoding:"utf-8"}));await S(s,JSON.stringify(C(h),void 0,2))}else x.warn("plugin.json \u4E0D\u5B58\u5728\uFF0C\u6253\u5305\u540E\u65E0\u6CD5\u88ABuTools\u6B63\u5E38\u52A0\u8F7D");let d=e.join(t,i);await n.copyFile(j,d),await $(t);let y=await O();y.length>0&&await D(p,t,...y)}}}}export{q as default};
