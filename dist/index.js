var B="vite-plugin-utools-plugin";import e from"node:path";import n from"node:fs/promises";import M from"ora";import T from"node:path";import U from"node:fs/promises";function k(o,l){return o=o.endsWith("plugin.json")?o:T.join(o,"plugin.json"),U.writeFile(o,l,{encoding:"utf-8"})}function W(o,l,r,c,w){let P={logo:l,main:r,features:[]};return JSON.stringify(o?{...P,development:{main:`${c}/${r}`},$schema:w}:P,void 0,2)}function C(o){let l={...o};return delete l.$schema,delete l.development,l}import{globby as V}from"globby";import{build as H}from"tsup";function A(o,l,r,c,...w){return H({dts:!1,watch:!1,entry:w,outDir:l,sourcemap:o,clean:!1,format:"cjs",noExternal:r,bundle:!0,minify:!1,target:`node${c??14}`,platform:"node",outExtension(){return{js:".js"}}})}import _ from"chokidar";var y=M({prefixText:"[utools]"});function q(o,l,r){let c=t=>e.resolve(process.cwd(),t),w=t=>t.endsWith("/")?t.slice(0,t.length-1):t,P=t=>n.stat(t).then(s=>s.isDirectory()).catch(()=>!1),J=t=>n.stat(t).then(s=>s.isFile()).catch(()=>!1),R=(t,s)=>{let i=r?.tsup?.ignoreEntry;if(!i)return!1;let m=d=>typeof d=="string"?d===t:d.test(t);return Array.isArray(i)?i.some(d=>m(d)):typeof i=="function"?i(t,s):m(i)},g=!0,I="",L="",f="",u="",p="",$,j="",D=(t,s,...i)=>A(t,s,r?.tsup?.noExternal??[],r?.tsup?.nodeVersion??14,...i),E=()=>V(["*.ts","*.tsx","*.js","*.jsx"],{onlyFiles:!0,cwd:p}).then(t=>t.filter(s=>!R(e.join(p,s),g)).map(s=>`${e.relative(process.cwd(),p)}/${s}`));return{name:B,config(t,s){g=s.command!=="build",(r?.build?.relativeBasePath??!0)&&!g&&(y.warn("\u6253\u5305\u5F3A\u5236\u4F7F\u7528\u76F8\u5BF9\u8DEF\u5F84"),t.base===void 0?t.base="./":t.base.startsWith("/")&&(t.base="."+t.base));let m=r?.server??{host:"localhost"};return t.server??={},Object.assign(t.server,m),f=c(e.relative(process.cwd(),o)),t},async configResolved(t){let s=!!t.server.https,i=parseInt(String(t.server.port??5173)),m=t.server.host??"localhost";I=c(e.relative(process.cwd(),t.publicDir)),L=c(e.relative(process.cwd(),t.build.outDir));let d=`${s?"https":"http"}//${m}:${i}`;p=c(l);let x=r?.clean??!0,h=w(r?.devDir??".utools");(h==="public"||h==="./public"||h==="/public")&&(h+="/.utools"),u=c(h),x&&await n.rm(u,{force:!0,recursive:!0}),await P(p)||(y.warn(`${l}\u4E0D\u5B58\u5728\uFF0C\u521B\u5EFA\u8BE5\u6587\u4EF6\u5939`),await n.mkdir(p,{recursive:!0}));let b=e.join(p,"plugin.json"),F=e.basename(f);if(await J(b)||await k(b,W(g,F,r?.utools?.main??"index.html",d,r?.utools?.jsonSchemaPath??"../node_modules/utools-api-types/resource/utools.schema.json")),j=e.join(p,F),f!==j&&await n.copyFile(f,j),g){await n.mkdir(u,{recursive:!0}),await n.copyFile(b,e.join(u,"plugin.json")),await n.copyFile(j,e.join(u,F));let O=c("package.json");await J(O)&&JSON.parse(await n.readFile(O,{encoding:"utf-8"})).type==="module"&&(y.warn("\u6839\u9879\u76EE\u8DEF\u5F84\u4E3Aesm\u6A21\u5F0F\uFF0C\u521B\u5EFApackage.json\u4FDD\u8BC1\u517C\u5BB9"),await n.writeFile(e.join(u,"package.json"),JSON.stringify({type:"commonjs"},void 0,2),{encoding:"utf-8"}));let S=await E();console.log(S),S.length>0&&await D(g,u,...S);let N=a=>{[".js",".ts",".tsx",".jsx"].some(v=>a.endsWith(v))&&D(g,u,e.relative(process.cwd(),a).replaceAll("\\","/")),(a===f||a===b)&&n.copyFile(a,e.join(u,e.basename(a)))};$=_.watch(p).on("change",N).on("add",N).on("unlink",a=>{if([".js",".ts",".tsx",".jsx"].some(v=>a.endsWith(v))){let v=e.join(u,e.relative(p,a)).replace(".ts",".js").replace(".jsx",".js").replace(".tsx",".js");n.rm(v,{force:!0,recursive:!0}),n.rm(v+".map",{force:!0,recursive:!0})}(a===f||a===b)&&n.rm(e.join(u,e.basename(a)),{force:!0,recursive:!0})})}},async closeBundle(){$?.close();let t=c("dist");if(!g&&await P(t)){let s=e.join(t,"plugin.json"),i=e.basename(f),m=e.join(p,"plugin.json");if(await J(j)){let h=JSON.parse(await n.readFile(m,{encoding:"utf-8"}));await k(s,JSON.stringify(C(h),void 0,2))}else y.warn("plugin.json \u4E0D\u5B58\u5728\uFF0C\u6253\u5305\u540E\u65E0\u6CD5\u88ABuTools\u6B63\u5E38\u52A0\u8F7D");let d=e.join(t,i);await n.copyFile(j,d);let x=await E();x.length>0&&await D(g,t,...x)}}}}export{q as default};
